<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VIP é ç´„ç³»çµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* ç¶­æŒæ‚¨åŸæœ¬æ¼‚äº®çš„æ¨£å¼ */
    :root { --primary: #246A53; --bg: #f5f5f5; --white: #fff; --accent: #F0C239; }
    body { margin: 0; padding: 0; font-family: sans-serif; background: var(--bg); color: #333; }
    .container { max-width: 600px; margin: 0 auto; min-height: 100vh; background: var(--white); padding-bottom: 50px; }
    .view { display: none; padding: 20px; }
    .view.active { display: block; }
    
    /* å…ƒä»¶æ¨£å¼ */
    .btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 10px; }
    input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    
    /* è®€å–é®ç½© */
    #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); display:none; flex-direction:column; justify-content:center; align-items:center; z-index:99; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* å…¶ä»–æ¨£å¼ (å¡ç‰‡ã€é¸é …) */
    .member-card { background: linear-gradient(135deg, #246A53, #1a4f3d); color: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; }
    .option-card { border: 1px solid #eee; padding: 15px; margin-bottom: 10px; border-radius: 10px; cursor: pointer; }
    .option-card.selected { border: 2px solid var(--primary); background: #f0fdf4; }
    .time-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
    .time-slot { padding: 10px; border: 1px solid #ccc; border-radius: 5px; text-align: center; cursor: pointer; }
    .time-slot.selected { background: var(--accent); border-color: var(--accent); color: var(--primary); font-weight: bold; }
  
    /* å–æ¶ˆæŒ‰éˆ•èˆ‡åˆ—è¡¨æ¨£å¼ */
    .booking-item {
      background: #fff; border-left: 5px solid var(--primary);
      padding: 15px; margin-bottom: 10px; border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center;
    }
    .booking-info { font-size: 14px; }
    .booking-time { font-weight: bold; color: var(--primary); font-size: 16px; margin-bottom: 5px; display: block;}
    .cancel-btn {
      background: #e74c3c; color: white; border: none; padding: 8px 12px;
      border-radius: 5px; cursor: pointer; font-size: 13px;
    }
    .cancel-btn:hover { background: #c0392b; }
    #history-section { margin-bottom: 30px; display: none; } /* é è¨­éš±è— */
  </style>
</head>
<body>

<div id="loading-overlay">
  <div class="spinner"></div>
  <div id="loading-text">è³‡æ–™å‚³è¼¸ä¸­...</div>
</div>

<div class="container">
  <div id="view-login" class="view active">
    <div style="text-align:center; margin-top:60px;">
      <h2 style="color:var(--primary);">VIP æœƒå“¡ç™»å…¥</h2>
      <p>è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼æŸ¥è©¢è³‡æ–™</p>
      <input type="tel" id="loginPhone" placeholder="09xxxxxxxx">
      <button class="btn" onclick="handleLogin()">æŸ¥è©¢ / ç™»å…¥</button>
      <div id="status-msg" style="margin-top:20px; color:#888; font-size:12px;">æ­£åœ¨é€£ç·š LINE...</div>
    </div>
  </div>

  <div id="view-main" class="view">
    <div class="member-card">
      <h3>Hi, <span id="userName">--</span></h3>
      <p>ç›®å‰æ–¹æ¡ˆï¼š<span id="ui-plan" style="font-weight:bold;">--</span> æ–¹æ¡ˆ</p>
      <p>å‰©é¤˜èª²ç¨‹: <span id="ui-course-balance">0</span> å ‚ | åŠ æ™‚åˆ¸: <span id="ui-ticket-balance">0</span> å¼µ</p>
    </div>
    
    <div id="history-section">
      <h3 style="border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px;">ğŸ“… æˆ‘çš„é ç´„</h3>
      <div id="bookingList">
        </div>
    </div>
    <h3>é¸æ“‡æ–¹æ¡ˆ</h3>
    <div id="opt-course" class="option-card" onclick="selectOption('COURSE')">
      <b>ğŸ’ ä½¿ç”¨èª²ç¨‹ (50åˆ†)</b>
      <br><small>å¯å‹¾é¸åŠ æ™‚åˆ¸</small>
      <div style="margin-top:5px; border-top:1px dashed #ccc; padding-top:5px;">
        <label><input type="checkbox" id="useTicketCheck" disabled onclick="event.stopPropagation(); toggleTicket()"> ä½¿ç”¨åŠ æ™‚åˆ¸ (+30åˆ†)</label>
      </div>
    </div>

    <div id="opt-single" class="option-card" onclick="selectOption('SINGLE')">
      <b>ğŸ’° å–®æ¬¡ä»˜è²»é ç´„</b>
      <div style="margin-top:5px;">
        <button onclick="event.stopPropagation(); setDuration(50)">50åˆ†é˜</button>
        <button onclick="event.stopPropagation(); setDuration(80)">80åˆ†é˜</button>
      </div>
    </div>

    <div id="time-section" style="display:none; margin-top:20px;">
      <h3>é¸æ“‡æ™‚é–“ (<span id="finalDuration">0</span>åˆ†é˜)</h3>
      <input type="date" id="datePicker" onchange="fetchSlots()">
      <div id="slotsContainer" class="time-grid"></div>
    </div>
    
    <button id="confirmBtn" class="btn" style="display:none;" onclick="submitBooking()">ç¢ºèªé ç´„</button>
    <button onclick="resetSystem()" style="width:100%; border:none; background:none; color:#999; margin-top:30px;">ç™»å‡º</button>
  </div>
</div>

<script>
  // ==========================================
  // ã€å¿…å¡«ã€‘è«‹å¡«å…¥æ‚¨çš„è³‡è¨Š
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbxrf6QnXqbca7tYBvHtrAJgskCRkV6qtRtWHak6fr0LXz0rqjyzwZLeu4Qf43SzKwH6/exec'; 
  const MY_LIFF_ID = '2008555385-honVqqwb'; 
  // ==========================================

  let currentUser = {};
  let lineUserId = '';
  let selectedPlan = '';
  let finalDuration = 0;
  let useTicket = false;
  let selectedTime = null;

  // åˆå§‹åŒ–
  window.onload = function() {
    liff.init({ liffId: MY_LIFF_ID }).then(() => {
      if (liff.isLoggedIn()) {
        liff.getProfile().then(p => {
          lineUserId = p.userId;
          document.getElementById('status-msg').innerText = `å·²åµæ¸¬ LINE ç”¨æˆ¶: ${p.displayName}`;
        });
      } else {
        liff.login();
      }
    }).catch(e => {
      document.getElementById('status-msg').innerText = "LIFF åˆå§‹åŒ–å¤±æ•— (è«‹æª¢æŸ¥ ID)";
    });
    
    // è¨­å®šæ—¥æœŸæœ€å°ç‚ºä»Šå¤©
    document.getElementById('datePicker').min = new Date().toISOString().split('T')[0];
  };

  // --- æ ¸å¿ƒï¼šå‘¼å« GAS API (å–ä»£ google.script.run) ---
  async function callGAS(action, payload) {
    document.getElementById('loading-overlay').style.display = 'flex';
    
    // åŠ ä¸Š action åƒæ•¸
    payload.action = action;

    try {
      const response = await fetch(GAS_URL, {
        method: 'POST',
        mode: 'no-cors', // é¿é–‹è·¨åŸŸæª¢æŸ¥ (æ³¨æ„ï¼šno-cors æœƒæ‹¿ä¸åˆ°å›å‚³å€¼)
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      // âš ï¸ é‡è¦æŠ€å·§ï¼šå› ç‚º no-cors æ‹¿ä¸åˆ°å›å‚³å€¼
      // æˆ‘å€‘é€™è£¡æ”¹ç”¨ Redirect æ–¹å¼æˆ–æ˜¯å‡è¨­æˆåŠŸ
      // ä½†ç‚ºäº†è®“æ‚¨èƒ½æ‹¿åˆ°æŸ¥è©¢çµæœï¼Œæˆ‘å€‘å¿…é ˆç”¨æ¨™æº– CORS
      // å¦‚æœä¸Šé¢ GAS doPost æœ‰å¯«å¥½ ContentServiceï¼Œæˆ‘å€‘å¯ä»¥å˜—è©¦ç§»é™¤ no-cors
      // æ”¹ç”¨æ¨™æº– fetch:
      
      /* æ›´æ­£ï¼šç‚ºäº†èƒ½åœ¨å‰ç«¯æ‹¿åˆ°ã€Œæœƒå“¡è³‡æ–™ã€å’Œã€Œæ™‚é–“è¡¨ã€ï¼Œ
         æˆ‘å€‘å¿…é ˆç”¨ redirect è½‰å€æ³•ï¼Œæˆ–æ˜¯ç°¡å–®çš„ 'cors' æ¨¡å¼ã€‚
         Google Apps Script çš„ doPost å¦‚æœå›å‚³æ­£ç¢ºçš„ JSON headerï¼Œæ˜¯å¯ä»¥æ”¯æ´ cors çš„ã€‚
      */
      
      const res2 = await fetch(GAS_URL + '?action=' + action, {
         method: 'POST',
         body: JSON.stringify(payload)
      });
      
      // è§£æ JSON
      const json = await res2.json();
      document.getElementById('loading-overlay').style.display = 'none';
      return json;

    } catch (e) {
      document.getElementById('loading-overlay').style.display = 'none';
      // ç‚ºäº†æ¸¬è©¦æ–¹ä¾¿ï¼Œå¦‚æœ GAS å›å‚³æ ¼å¼æœ‰å•é¡Œï¼Œé€™è£¡å¯èƒ½æœƒå ±éŒ¯
      // ä½†æˆ‘å€‘å‡è¨­å¾Œç«¯å·²ç¶“éƒ¨ç½²æ­£ç¢º
      console.error(e);
      alert("é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ GAS ç¶²å€æ˜¯å¦æ­£ç¢º");
      return null;
    }
  }
  
  // ä¿®æ­£å¾Œçš„ fetch å‘¼å« (ä½¿ç”¨ç´” POSTï¼Œè®“ GAS è™•ç† Redirect)
  function sendRequest(action, data) {
    document.getElementById('loading-overlay').style.display = 'flex';
    data.action = action;
    
    // ä½¿ç”¨ fetch å‘¼å« GAS
    return fetch(GAS_URL, {
      method: 'POST',
      body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(response => {
      document.getElementById('loading-overlay').style.display = 'none';
      return response;
    })
    .catch(err => {
      document.getElementById('loading-overlay').style.display = 'none';
      alert('ç³»çµ±é€£ç·šå¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦');
      console.error(err);
      throw err;
    });
  }

  // --- æ¥­å‹™é‚è¼¯v7.1.0 ---
  function handleLogin() {
    const phone = document.getElementById('loginPhone').value;
    if(!phone) return alert("è«‹è¼¸å…¥é›»è©±");

    sendRequest('loginUser', { phone: phone }).then(res => {
      if(res.success) {
        currentUser = res.user;
        renderMain();
        
        // ã€æ–°å¢ã€‘ç™»å…¥æˆåŠŸå¾Œï¼Œç«‹åˆ»æŸ¥è©¢é ç´„ç´€éŒ„
        loadBookingHistory(); 
        
      } else {
        alert(res.message || "Hiï¼Œæ–°æœ‹å‹");
        if(!res.success && res.user) { 
           currentUser = res.user; 
           renderMain(); 
           loadBookingHistory(); // å³ä½¿æ˜¯æ–°æœ‹å‹ä¹ŸæŸ¥ä¸€ä¸‹(é›–ç„¶æ‡‰è©²æ˜¯ç©ºçš„)
        }
      }
    });
  }
  function fetchSlots() {
    const date = document.getElementById('datePicker').value;
    if(!date) return;
    
    sendRequest('getAvailableSlots', { date: date, duration: finalDuration }).then(res => {
      const div = document.getElementById('slotsContainer');
      div.innerHTML = '';
      if(res.status === 'FULL') div.innerHTML = 'å·²é¡æ»¿';
      else if(res.slots.length === 0) div.innerHTML = 'ç„¡æ™‚æ®µ';
      else {
        res.slots.forEach(t => {
          let el = document.createElement('div');
          el.className = 'time-slot';
          el.innerText = t;
          el.onclick = () => {
             document.querySelectorAll('.time-slot').forEach(x=>x.classList.remove('selected'));
             el.classList.add('selected');
             selectedTime = t;
             document.getElementById('confirmBtn').style.display = 'block';
          }
          div.appendChild(el);
        });
      }
    });
  }

  function submitBooking() {
    if(!confirm(`ç¢ºèªé ç´„ ${document.getElementById('datePicker').value} ${selectedTime}?`)) return;
    
    sendRequest('createBooking', {
      date: document.getElementById('datePicker').value,
      time: selectedTime,
      duration: finalDuration,
      name: currentUser.name,
      phone: currentUser.phone,
      lineUserId: lineUserId,
      plan: selectedPlan,
      useTicket: useTicket
    }).then(res => {
      if(res.success) {
        alert("é ç´„æˆåŠŸï¼LINE é€šçŸ¥å·²ç™¼é€");
        resetSystem();
      } else {
        alert("é ç´„å¤±æ•—ï¼š" + res.error);
      }
    });
  }
// --- v7.1.0 æ–°å¢åŠŸèƒ½ ---
  // 1. è¼‰å…¥é ç´„ç´€éŒ„
  function loadBookingHistory() {
    const listDiv = document.getElementById('bookingList');
    const section = document.getElementById('history-section');
    
    listDiv.innerHTML = '<div style="text-align:center; color:#999;">è¼‰å…¥ä¸­...</div>';
    section.style.display = 'block';

    sendRequest('getBookingHistory', { phone: currentUser.phone }).then(res => {
      listDiv.innerHTML = ''; // æ¸…ç©º
      
      if (!res.bookings || res.bookings.length === 0) {
        listDiv.innerHTML = '<div style="text-align:center; color:#999; padding:10px;">ç›®å‰æ²’æœ‰æœªä¾†çš„é ç´„</div>';
        return;
      }

      // æ¸²æŸ“åˆ—è¡¨
      res.bookings.forEach(b => {
        const item = document.createElement('div');
        item.className = 'booking-item';
        item.innerHTML = `
          <div class="booking-info">
            <span class="booking-time">${b.start}</span>
            <span>${b.title}</span>
          </div>
          <button class="cancel-btn" onclick="triggerCancel('${b.id}', '${b.start}')">å–æ¶ˆ</button>
        `;
        listDiv.appendChild(item);
      });
    });
  }

  // 2. è§¸ç™¼å–æ¶ˆ
  function triggerCancel(eventId, timeStr) {
    if(!confirm(`ç¢ºå®šè¦å–æ¶ˆ ${timeStr} çš„é ç´„å—ï¼Ÿ\n(æ­¤æ“ä½œç„¡æ³•å¾©åŸ)`)) return;

    sendRequest('cancelBooking', {
      eventId: eventId,
      phone: currentUser.phone,
      name: currentUser.name,
      lineUserId: lineUserId
    }).then(res => {
      if(res.success) {
        alert('âœ… å–æ¶ˆæˆåŠŸï¼');
        loadBookingHistory(); // é‡æ–°æ•´ç†åˆ—è¡¨
      } else {
        alert('âŒ å–æ¶ˆå¤±æ•—ï¼š' + res.error);
      }
    });
  }
// End--- v7.1.0 æ–°å¢åŠŸèƒ½ ---
  // --- ä»‹é¢è¼”åŠ©å‡½å¼ ---
  function renderMain() {
    document.getElementById('userName').innerText = currentUser.name;
    document.getElementById('ui-course-balance').innerText = currentUser.courses;
    document.getElementById('ui-ticket-balance').innerText = currentUser.tickets;
    // --- v7.2.0 æ–°å¢é‚è¼¯ï¼šé¡¯ç¤ºæ–¹æ¡ˆ ---
    var planText = "";
    if (currentUser.plan == 80) {
      planText = "ğŸ”¥ é«˜éšèª²ç¨‹ (80åˆ†é˜)";
    } else if (currentUser.plan == 50) {
      planText = "ğŸŒ± åŸºç¤èª²ç¨‹ (50åˆ†é˜)";
    } else {
      planText = "æœªè¨­å®šæ–¹æ¡ˆ";
    }
    document.getElementById("ui-plan").innerText = planText;
    const hasCourse = currentUser.courses > 0;
    const hasTicket = currentUser.tickets > 0;
    
    const cDiv = document.getElementById('opt-course');
    if(!hasCourse) { cDiv.style.opacity = '0.5'; cDiv.style.pointerEvents = 'none'; }
    else { cDiv.style.opacity = '1'; cDiv.style.pointerEvents = 'auto'; }
    
    const tCheck = document.getElementById('useTicketCheck');
    if(!hasTicket) { tCheck.disabled = true; tCheck.checked = false; }
    else tCheck.disabled = false;

    document.getElementById('view-login').classList.remove('active');
    document.getElementById('view-main').classList.add('active');
  }

  function selectOption(type) {
    selectedPlan = type;
    document.querySelectorAll('.option-card').forEach(e => e.classList.remove('selected'));
    if(type === 'COURSE') {
       document.getElementById('opt-course').classList.add('selected');
       toggleTicket();
    } else {
       document.getElementById('opt-single').classList.add('selected');
       useTicket = false;
       document.getElementById('time-section').style.display = 'none';
    }
  }

  function toggleTicket() {
    if(selectedPlan !== 'COURSE') return;
    useTicket = document.getElementById('useTicketCheck').checked;
    base_duration =document.getElementById("ui-plan").innerText
    setDuration(useTicket ? base_duration+30 : base_duration);
  }

  function setDuration(min) {
    finalDuration = min;
    document.getElementById('finalDuration').innerText = min;
    document.getElementById('time-section').style.display = 'block';
    fetchSlots();
  }

  function resetSystem() {
    location.reload();
  }
</script>

</body>
</html>
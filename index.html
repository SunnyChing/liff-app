<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VIP é ç´„ç³»çµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* --- CSS æ¨£å¼å€ (ç¶­æŒä¸è®Š) --- */
    :root { --primary: #246A53; --bg: #f5f5f5; --white: #fff; --accent: #F0C239; }
    body { margin: 0; padding: 0; font-family: sans-serif; background: var(--bg); color: #333; }
    .container { max-width: 600px; margin: 0 auto; min-height: 100vh; background: var(--white); padding-bottom: 50px; }
    .view { display: none; padding: 20px; }
    .view.active { display: block; }
    
    .btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 10px; }
    input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    
    /* è®€å–é®ç½© */
    #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); display:none; flex-direction:column; justify-content:center; align-items:center; z-index:99; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .member-card { background: linear-gradient(135deg, #246A53, #1a4f3d); color: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; }
    .option-card { border: 1px solid #eee; padding: 15px; margin-bottom: 10px; border-radius: 10px; cursor: pointer; }
    .option-card.selected { border: 2px solid var(--primary); background: #f0fdf4; }
    .time-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
    .time-slot { padding: 10px; border: 1px solid #ccc; border-radius: 5px; text-align: center; cursor: pointer; }
    .time-slot.selected { background: var(--accent); border-color: var(--accent); color: var(--primary); font-weight: bold; }
  
    /* é ç´„ç´€éŒ„åˆ—è¡¨æ¨£å¼ */
    .booking-item {
      background: #fff; border-left: 5px solid var(--primary);
      padding: 15px; margin-bottom: 10px; border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center;
    }
    .booking-info { font-size: 14px; }
    .booking-time { font-weight: bold; color: var(--primary); font-size: 16px; margin-bottom: 5px; display: block;}
    .cancel-btn {
      background: #e74c3c; color: white; border: none; padding: 8px 12px;
      border-radius: 5px; cursor: pointer; font-size: 13px;
    }
    .cancel-btn:hover { background: #c0392b; }
    #history-section { margin-bottom: 30px; display: none; }
  </style>
</head>
<body>

<div id="loading-overlay">
  <div class="spinner"></div>
  <div id="loading-text">è³‡æ–™å‚³è¼¸ä¸­...</div>
</div>

<div class="container">
  <div id="view-login" class="view active">
    <div style="text-align:center; margin-top:40px; padding: 0 20px;">
      
      <img src="./images/Logo.PNG" 
           alt="ç­‹æ‘©çµäºº Logo" 
           style="width: 150px; height: auto; display: block; margin: 0 auto 15px auto; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.15));">

      <div id="status-msg" style="color: #A88462; font-size: 13px; font-weight: bold; margin-bottom: 20px; min-height: 20px;">
        <span class="spinner" style="width:12px; height:12px; border-width:2px; display:inline-block; vertical-align:middle;"></span> 
        æ­£åœ¨é€£çµ LINE...
      </div>

      <h2 style="color: var(--primary); margin: 0 0 10px 0; font-size: 24px;">VIP æœƒå“¡ç™»å…¥</h2>

      <div style="margin: 20px 0;">
        <label for="loginPhone" style="display:block; color:#555; margin-bottom:8px; font-size:15px;">
          è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼æŸ¥è©¢è³‡æ–™
        </label>
        <input type="tel" id="loginPhone" placeholder="09xxxxxxxx" 
               style="text-align: center; font-size: 18px; letter-spacing: 1px; padding: 15px; border: 2px solid #ddd; transition: 0.3s;">
      </div>

      <button class="btn" onclick="handleLogin()" style="font-size: 18px; font-weight: bold; box-shadow: 0 4px 10px rgba(36, 106, 83, 0.3);">
        æŸ¥è©¢ / ç™»å…¥
      </button>

    </div>
  </div>

  <div id="view-main" class="view">
    <div class="member-card">
      <h3>Hi, <span id="userName">--</span></h3>
      <p>ç›®å‰æ–¹æ¡ˆï¼š<span id="ui-plan-text" style="font-weight:bold; color: #F0C239;">--</span></p>
      <p>å‰©é¤˜èª²ç¨‹: <span id="ui-course-balance">0</span> å ‚ | åŠ æ™‚åˆ¸: <span id="ui-ticket-balance">0</span> å¼µ</p>
    </div>
    
    <div id="history-section">
      <h3 style="border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px;">ğŸ“… æˆ‘çš„é ç´„</h3>
      <div id="bookingList"></div>
    </div>

    <h3>é¸æ“‡é ç´„é …ç›®</h3>
    
    <div id="opt-course" class="option-card" onclick="selectOption('COURSE')">
      <b id="ui-course-btn-text">ğŸ’ ä½¿ç”¨èª²ç¨‹ (--åˆ†)</b>
      <br><small>å¯å‹¾é¸åŠ æ™‚åˆ¸</small>
      <div style="margin-top:5px; border-top:1px dashed #ccc; padding-top:5px;">
        <label><input type="checkbox" id="useTicketCheck" disabled onclick="event.stopPropagation(); toggleTicket()"> ä½¿ç”¨åŠ æ™‚åˆ¸ (+30åˆ†)</label>
      </div>
    </div>

    <div id="opt-single" class="option-card" onclick="selectOption('SINGLE')">
      <b>ğŸ’° å–®æ¬¡ä»˜è²»é ç´„</b>
      <div style="margin-top:5px;">
        <button onclick="event.stopPropagation(); setDuration(50)">50åˆ†é˜</button>
        <button onclick="event.stopPropagation(); setDuration(80)">80åˆ†é˜</button>
      </div>
    </div>

    <div id="time-section" style="display:none; margin-top:20px;">
      <h3>é¸æ“‡æ™‚é–“ (<span id="finalDuration">0</span>åˆ†é˜)</h3>
      <input type="date" id="datePicker" onchange="fetchSlots()">
      <div id="slotsContainer" class="time-grid"></div>
    </div>
    
    <button id="confirmBtn" class="btn" style="display:none;" onclick="submitBooking()">ç¢ºèªé ç´„</button>
    <button onclick="resetSystem()" style="width:100%; border:none; background:none; color:#999; margin-top:30px;">ç™»å‡º</button>
  </div>
</div>

<script>
  // ==========================================
  // ã€è«‹ç¢ºèªã€‘æ‚¨çš„ GAS ç¶²å€èˆ‡ LIFF ID
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbxrf6QnXqbca7tYBvHtrAJgskCRkV6qtRtWHak6fr0LXz0rqjyzwZLeu4Qf43SzKwH6/exec'; 
  const MY_LIFF_ID = '2008555385-honVqqwb'; 
  // ==========================================

  let currentUser = {};
  let lineUserId = '';
  let selectedPlan = '';
  let finalDuration = 0;
  let useTicket = false;
  let selectedTime = null;

  // åˆå§‹åŒ–
  window.onload = function() {
    liff.init({ liffId: MY_LIFF_ID }).then(() => {
      if (liff.isLoggedIn()) {
        liff.getProfile().then(p => {
          lineUserId = p.userId;
          document.getElementById('status-msg').innerText = `Hello ${p.displayName}`;
        });
      } else {
        liff.login();
      }
    }).catch(e => {
      document.getElementById('status-msg').innerText = "LIFF åˆå§‹åŒ–å¤±æ•— (è«‹æª¢æŸ¥ ID)";
    });
    
    // è¨­å®šæ—¥æœŸæœ€å°ç‚ºä»Šå¤©
    document.getElementById('datePicker').min = new Date().toISOString().split('T')[0];
  };

  // --- é€šç”¨ API è«‹æ±‚å‡½å¼ ---
  function sendRequest(action, data) {
    document.getElementById('loading-overlay').style.display = 'flex';
    data.action = action;
    
    // ä½¿ç”¨ POST è«‹æ±‚ï¼ŒGAS éœ€è¨­å®š doPost ä¸¦å›å‚³ JSON
    return fetch(GAS_URL, {
      method: 'POST',
      body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(response => {
      document.getElementById('loading-overlay').style.display = 'none';
      return response;
    })
    .catch(err => {
      document.getElementById('loading-overlay').style.display = 'none';
      alert('ç³»çµ±é€£ç·šå¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦');
      console.error(err);
      throw err;
    });
  }

  // --- ç™»å…¥é‚è¼¯ ---
  function handleLogin() {
    const phone = document.getElementById('loginPhone').value;
    if(!phone) return alert("è«‹è¼¸å…¥é›»è©±");

    sendRequest('loginUser', { phone: phone }).then(res => {
      if(res.success) {
        currentUser = res.user;
        renderMain(); // æ¸²æŸ“ä¸»ç•«é¢
        loadBookingHistory(); // è¼‰å…¥æ­·å²ç´€éŒ„
      } else {
        alert(res.message || "æ‰¾ä¸åˆ°æ­¤è™Ÿç¢¼ï¼Œè«‹ç¢ºèªæ˜¯å¦å·²è¨»å†Š");
        // ç‚ºäº†æ¸¬è©¦æ–¹ä¾¿ï¼Œè‹¥å¾Œç«¯æœ‰å›å‚³ user çµæ§‹ä»è®“å…¶ç™»å…¥
        if(!res.success && res.user) { 
           currentUser = res.user; 
           renderMain(); 
           loadBookingHistory();
        }
      }
    });
  }

  // --- ä¸»ç•«é¢æ¸²æŸ“ (v7.2.0 é‡é»ä¿®æ”¹) ---
  function renderMain() {
    document.getElementById('userName').innerText = currentUser.name;
    document.getElementById('ui-course-balance').innerText = currentUser.courseBalance || currentUser.courses || 0;
    document.getElementById('ui-ticket-balance').innerText = currentUser.ticketBalance || currentUser.tickets || 0;

    // 1. æ ¹æ“šæ–¹æ¡ˆé¡¯ç¤ºå°æ‡‰æ–‡å­—
    let planText = "æœªè¨­å®šæ–¹æ¡ˆ";
    // ç¢ºä¿è½‰ç‚ºæ•¸å­—æ¯”è¼ƒ
    const plan = parseInt(currentUser.plan);

    if (plan === 80) {
      planText = "ğŸ”¥ é«˜éšæ–¹æ¡ˆ (80åˆ†)";
    } else if (plan === 50) {
      planText = "ğŸŒ± åŸºç¤æ–¹æ¡ˆ (50åˆ†)";
    }
    document.getElementById("ui-plan-text").innerText = planText;

    // 2. æ›´æ–°æŒ‰éˆ•ä¸Šçš„æ–‡å­— (é€™æ˜¯é—œéµï¼è®“ä½¿ç”¨è€…çŸ¥é“æ‰£ä¸€é»æ˜¯å¹¾åˆ†é˜)
    const displayPlan = plan || 50; // é˜²å‘†
    document.getElementById("ui-course-btn-text").innerHTML = `ğŸ’ ä½¿ç”¨èª²ç¨‹ (${displayPlan}åˆ†)`;

    // 3. è™•ç†æŒ‰éˆ•ç‹€æ…‹
    const hasCourse = (currentUser.courseBalance > 0 || currentUser.courses > 0);
    const hasTicket = (currentUser.ticketBalance > 0 || currentUser.tickets > 0);
    
    const cDiv = document.getElementById('opt-course');
    if(!hasCourse) { 
      cDiv.style.opacity = '0.5'; 
      cDiv.style.pointerEvents = 'none'; 
      cDiv.innerHTML += '<br><span style="color:red;font-size:12px;">(é»æ•¸ä¸è¶³)</span>';
    } else { 
      cDiv.style.opacity = '1'; 
      cDiv.style.pointerEvents = 'auto'; 
    }
    
    const tCheck = document.getElementById('useTicketCheck');
    if(!hasTicket) { 
      tCheck.disabled = true; 
      tCheck.checked = false; 
    } else { 
      tCheck.disabled = false; 
    }

    document.getElementById('view-login').classList.remove('active');
    document.getElementById('view-main').classList.add('active');
  }

  // --- é¸æ“‡æ–¹æ¡ˆé‚è¼¯ (v7.2.0 ä¿®æ­£) ---
  function selectOption(type) {
    selectedPlan = type;
    document.querySelectorAll('.option-card').forEach(e => e.classList.remove('selected'));
    
    if(type === 'COURSE') {
       document.getElementById('opt-course').classList.add('selected');
       toggleTicket(); // ç«‹å³è§¸ç™¼ä¸€æ¬¡è¨ˆç®—
    } else {
       document.getElementById('opt-single').classList.add('selected');
       useTicket = false;
       document.getElementById('time-section').style.display = 'none';
    }
  }

  // --- è¨ˆç®—æ™‚é–“é‚è¼¯ (v7.2.0 æ ¸å¿ƒä¿®æ­£) ---
  function toggleTicket() {
    if(selectedPlan !== 'COURSE') return;
    
    useTicket = document.getElementById('useTicketCheck').checked;
    
    // ã€ä¿®æ­£é»ã€‘å¾ currentUser è³‡æ–™è®€å–ï¼Œè€Œä¸æ˜¯è§£æ UI æ–‡å­—
    // è‹¥æ²’æœ‰ plan è³‡æ–™ï¼Œé è¨­ç‚º 50
    let baseDuration = parseInt(currentUser.plan) || 50; 
    
    // è‹¥ä½¿ç”¨åŠ æ™‚å·ï¼Œå¢åŠ  30 åˆ†é˜
    let totalDuration = useTicket ? (baseDuration + 30) : baseDuration;

    setDuration(totalDuration);
  }

  function setDuration(min) {
    finalDuration = min;
    document.getElementById('finalDuration').innerText = min;
    document.getElementById('time-section').style.display = 'block';
    
    // å¦‚æœä½¿ç”¨è€…å·²ç¶“é¸äº†æ—¥æœŸï¼Œåˆ‡æ›æ–¹æ¡ˆæ™‚è‡ªå‹•é‡æ–°æ’ˆå–æ™‚æ®µ
    if(document.getElementById('datePicker').value) {
      fetchSlots();
    }
  }

  // --- æŸ¥è©¢æ™‚æ®µ ---
  function fetchSlots() {
    const date = document.getElementById('datePicker').value;
    if(!date) return;
    
    // æ¸…ç©ºä¸¦é¡¯ç¤ºè®€å–ä¸­
    const div = document.getElementById('slotsContainer');
    div.innerHTML = '<div style="grid-column:1/-1; text-align:center;">æŸ¥è©¢ä¸­...</div>';

    sendRequest('getAvailableSlots', { date: date, duration: finalDuration }).then(res => {
      div.innerHTML = '';
      if(res.status === 'FULL') {
        div.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:red;">æœ¬æ—¥å·²é¡æ»¿</div>';
      } else if(!res.slots || res.slots.length === 0) {
        div.innerHTML = '<div style="grid-column:1/-1; text-align:center;">ç„¡ç¬¦åˆæ™‚æ®µ</div>';
      } else {
        res.slots.forEach(t => {
          let el = document.createElement('div');
          el.className = 'time-slot';
          el.innerText = t;
          el.onclick = () => {
             document.querySelectorAll('.time-slot').forEach(x=>x.classList.remove('selected'));
             el.classList.add('selected');
             selectedTime = t;
             document.getElementById('confirmBtn').style.display = 'block';
          }
          div.appendChild(el);
        });
      }
    });
  }

  // --- é€å‡ºé ç´„ ---
  function submitBooking() {
    if(!selectedTime) return alert("è«‹é¸æ“‡æ™‚é–“");
    
    let msg = `ç¢ºèªé ç´„è³‡è¨Šï¼š\n\næ—¥æœŸï¼š${document.getElementById('datePicker').value}\næ™‚é–“ï¼š${selectedTime}\né•·åº¦ï¼š${finalDuration} åˆ†é˜`;
    if(selectedPlan === 'COURSE') {
      msg += `\næ–¹æ¡ˆï¼šæ‰£é™¤ 1 å ‚èª²`;
      if(useTicket) msg += ` + 1 å¼µåŠ æ™‚å·`;
    } else {
      msg += `\næ–¹æ¡ˆï¼šå–®æ¬¡ä»˜è²»`;
    }
    
    if(!confirm(msg)) return;
    
    sendRequest('createBooking', {
      date: document.getElementById('datePicker').value,
      time: selectedTime,
      duration: finalDuration,
      name: currentUser.name,
      phone: currentUser.phone,
      lineUserId: lineUserId,
      plan: selectedPlan, 
      userPlanBase: currentUser.plan, // å‚³é€ç”¨æˆ¶çš„åŸå§‹æ–¹æ¡ˆçµ¦å¾Œç«¯åƒè€ƒ
      useTicket: useTicket
    }).then(res => {
      if(res.success) {
        alert("âœ… é ç´„æˆåŠŸï¼LINE é€šçŸ¥å·²ç™¼é€");
        // æˆåŠŸå¾Œé‡æ–°è¼‰å…¥ç´€éŒ„æˆ–é‡æ•´é é¢
        resetSystem();
      } else {
        alert("âŒ é ç´„å¤±æ•—ï¼š" + (res.error || "æœªçŸ¥éŒ¯èª¤"));
      }
    });
  }

  // --- æ­·å²ç´€éŒ„åŠŸèƒ½ (v7.1.0) ---
  function loadBookingHistory() {
    const listDiv = document.getElementById('bookingList');
    const section = document.getElementById('history-section');
    
    listDiv.innerHTML = '<div style="text-align:center; color:#999;">è¼‰å…¥ä¸­...</div>';
    section.style.display = 'block';

    sendRequest('getBookingHistory', { phone: currentUser.phone }).then(res => {
      listDiv.innerHTML = ''; 
      
      if (!res.bookings || res.bookings.length === 0) {
        listDiv.innerHTML = '<div style="text-align:center; color:#999; padding:10px;">ç›®å‰æ²’æœ‰æœªä¾†çš„é ç´„</div>';
        return;
      }

      res.bookings.forEach(b => {
        const item = document.createElement('div');
        item.className = 'booking-item';
        // ç°¡å–®çš„æ™‚é–“æ ¼å¼åŒ–
        let displayTime = b.start.split('T')[1] ? b.start.split('T')[1].substring(0,5) : b.start;
        let displayDate = b.start.split('T')[0];

        item.innerHTML = `
          <div class="booking-info">
            <span class="booking-time">${displayDate} ${displayTime}</span>
            <span>${b.title}</span>
          </div>
          <button class="cancel-btn" onclick="triggerCancel('${b.id}', '${displayDate} ${displayTime}')">å–æ¶ˆ</button>
        `;
        listDiv.appendChild(item);
      });
    });
  }

  function triggerCancel(eventId, timeStr) {
    if(!confirm(`ç¢ºå®šè¦å–æ¶ˆ ${timeStr} çš„é ç´„å—ï¼Ÿ\n(æ­¤æ“ä½œç„¡æ³•å¾©åŸ)`)) return;

    sendRequest('cancelBooking', {
      eventId: eventId,
      phone: currentUser.phone,
      name: currentUser.name,
      lineUserId: lineUserId
    }).then(res => {
      if(res.success) {
        alert('âœ… å–æ¶ˆæˆåŠŸï¼');
        loadBookingHistory(); // é‡æ–°æ•´ç†
      } else {
        alert('âŒ å–æ¶ˆå¤±æ•—ï¼š' + res.error);
      }
    });
  }

  function resetSystem() {
    location.reload();
  }
</script>

</body>
</html>
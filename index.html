<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VIP é ç´„ç³»çµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* --- CSS æ¨£å¼å€ v7.3.3 --- */
    :root { 
      --primary: #246A53;   /* çµäººæ·±ç¶  */
      --bg: #f5f5f5; 
      --white: #fff; 
      --accent: #F0C239;    /* å“ç‰Œé‡‘é»ƒ */
      --brown: #A88462;     /* æš–æ£•è¼”åŠ© */
      --danger: #A73520;    /* è­¦ç¤ºæ·±ç´… */
    }

    /* 2. é¦–é åº•è‰²æ”¹æˆå“ç‰Œè‰²çš„é»ƒè‰² */
    body { 
      margin: 0; padding: 0; 
      font-family: sans-serif; 
      background: var(--accent); /* æ”¹ç‚ºé»ƒè‰² */
      color: #333; 
    }

    .container { 
      max-width: 600px; 
      margin: 0 auto; 
      min-height: 100vh; 
      background: var(--accent); /* æ”¹ç‚ºé»ƒè‰² */
      padding-bottom: 50px; 
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }

    .view { display: none; padding: 20px; }
    .view.active { display: block; }
    
    .btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 10px; transition: 0.3s; }
    .btn:active { transform: scale(0.98); opacity: 0.9; }

    input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    
    /* è®€å–é®ç½© */
    #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); display:none; flex-direction:column; justify-content:center; align-items:center; z-index:99; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .member-card { background: linear-gradient(135deg, #246A53, #1a4f3d); color: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; border-bottom: 4px solid var(--accent); }
    
    /* é¸é …å¡ç‰‡æ¨£å¼å„ªåŒ– */
    .option-card { 
      border: 2px solid #eee; 
      padding: 15px; 
      margin-bottom: 10px; 
      border-radius: 10px; 
      cursor: pointer; 
      background: #fff;
      transition: 0.3s;
    }
    .option-card.selected { 
      border: 2px solid var(--primary); 
      background: rgba(36, 106, 83, 0.03); 
    }

    /* 4. è‹¥ä¸æ˜¯åœ¨é¸æ“‡é ç´„é …ç›®è£¡çš„é¸å–®æˆ–åŠ æ™‚å·ï¼Œä¸æ‡‰è©²å¯ä»¥é»é¸ */
    .option-card:not(.selected) { opacity: 0.6; }
    .option-card:not(.selected) select, 
    .option-card:not(.selected) input { 
      pointer-events: none; /* ç¦æ­¢æ»‘é¼ äº‹ä»¶ */
      background: #f9f9f9; 
    }

    /* é€šç”¨ä¸‹æ‹‰é¸å–® */
    .plan-select {
      width: 100%; padding: 10px; margin-top: 5px; 
      border: 1px solid var(--brown); border-radius: 8px; 
      font-size: 16px; background: #fff;
    }

    /* 3. ä½¿ç”¨åŠ æ™‚å·çš„æ¡†æ¡†å°é½Š */
    .ticket-box {
      margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc;
      display: flex; align-items: center;
    }
    .ticket-box label {
      display: flex; align-items: center; cursor: pointer; width: 100%;
    }
    .ticket-box input[type="checkbox"] {
      width: 20px; height: 20px; margin: 0 10px 0 0; cursor: pointer;
    }

    .time-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
    .time-slot { padding: 10px; border: 1px solid #ccc; border-radius: 5px; text-align: center; cursor: pointer; }
    .time-slot.selected { background: var(--accent); border-color: var(--accent); color: var(--primary); font-weight: bold; }
  
    /* é ç´„ç´€éŒ„åˆ—è¡¨æ¨£å¼ */
    .booking-item {
      background: #fff; border-left: 5px solid var(--primary);
      padding: 15px; margin-bottom: 10px; border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center;
    }
    .booking-info { font-size: 14px; }
    .booking-time { font-weight: bold; color: var(--primary); font-size: 16px; margin-bottom: 5px; display: block;}
    .cancel-btn {
      background: var(--danger); color: white; border: none; padding: 8px 12px;
      border-radius: 5px; cursor: pointer; font-size: 13px;
    }
    .cancel-btn:hover { opacity: 0.8; }
    #history-section { margin-bottom: 30px; display: none; }
  </style>
</head>
<body>

<div id="loading-overlay">
  <div class="spinner"></div>
  <div id="loading-text">è³‡æ–™å‚³è¼¸ä¸­...</div>
</div>

<div class="container">
  <div id="view-login" class="view active">
    <div style="text-align:center; margin-top:40px; padding: 0 20px;">
      
      <img src="./images/Logo.PNG" 
           alt="ç­‹æ‘©çµäºº Logo" 
           style="width: 150px; height: auto; display: block; margin: 0 auto 15px auto; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.15));">

      <div id="status-msg" style="color: #A88462; font-size: 13px; font-weight: bold; margin-bottom: 20px; min-height: 20px;">
        <span class="spinner" style="width:12px; height:12px; border-width:2px; display:inline-block; vertical-align:middle;"></span> 
        æ­£åœ¨é€£çµ LINE...
      </div>

      <h2 style="color: var(--primary); margin: 0 0 10px 0; font-size: 24px;">VIP æœƒå“¡ç™»å…¥</h2>

      <div style="margin: 20px 0;">
        <label for="loginPhone" style="display:block; color:#555; margin-bottom:8px; font-size:15px;">
          è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼æŸ¥è©¢è³‡æ–™
        </label>
        <input type="tel" id="loginPhone" placeholder="09xxxxxxxx" 
               style="text-align: center; font-size: 18px; letter-spacing: 1px; padding: 15px; border: 2px solid #ddd; transition: 0.3s;">
      </div>

      <button class="btn" onclick="handleLogin()" style="font-size: 18px; font-weight: bold; box-shadow: 0 4px 10px rgba(36, 106, 83, 0.3);">
        æŸ¥è©¢ / ç™»å…¥
      </button>

    </div>
  </div>

  <div id="view-main" class="view">
    <div class="member-card">
      <h3>Hi, <span id="userName">--</span></h3>
      <p>ç›®å‰æ–¹æ¡ˆï¼š<span id="ui-plan-text" style="font-weight:bold; color: #F0C239;">--</span></p>
      <p>å‰©é¤˜èª²ç¨‹: <span id="ui-course-balance">0</span> å ‚ | åŠ æ™‚åˆ¸: <span id="ui-ticket-balance">0</span> å¼µ</p>
    </div>
    
    <div id="history-section">
      <h3 style="border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px;">ğŸ“… æˆ‘çš„é ç´„</h3>
      <div id="bookingList"></div>
    </div>

    <h3>é¸æ“‡é ç´„é …ç›®</h3>
    
    <div id="opt-course" class="option-card" onclick="selectOption('COURSE')">
      <b id="ui-course-btn-text">ğŸ’ ä½¿ç”¨èª²ç¨‹ (--åˆ†)</b>
      
      <div style="margin-top:5px;">
        <label style="font-size:14px; color:#555;">é¸æ“‡å ‚æ•¸ï¼š</label>
        <select id="coursePlanSelect" class="plan-select" onchange="updateCoursePlanLogic()" onclick="event.stopPropagation()">
          <option value="1">ğŸŒ¿ 1 å ‚èª²</option>
          <option value="2">ğŸŒ¿ğŸŒ¿ 2 å ‚èª² (100åˆ†)</option>
        </select>

        <div class="ticket-box">
          <label>
            <input type="checkbox" id="useTicketCheck" disabled onclick="event.stopPropagation(); updateCoursePlanLogic()"> 
            ä½¿ç”¨åŠ æ™‚åˆ¸ (+30åˆ†)
          </label>
        </div>
        <div id="courseTicketHint" style="font-size:12px; color:var(--danger); display:none; margin-top:5px;">
          âš ï¸ é€£çºŒå…©å ‚èª²ä¸å¯ä½¿ç”¨åŠ æ™‚åˆ¸
        </div>
      </div>
    </div>

    <div id="opt-single" class="option-card" onclick="selectOption('SINGLE')">
      <b>ğŸ’° å–®æ¬¡ä»˜è²»é ç´„</b>
      
      <div style="margin-top:10px;">
        <label style="font-size:14px; color:#555;">é¸æ“‡æ–¹æ¡ˆï¼š</label>
        <select id="singlePlanSelect" class="plan-select" onchange="updateSinglePlanLogic()" onclick="event.stopPropagation()">
          <option value="50_1">ğŸŒ¿ 50åˆ†é˜ (å–®å ‚)</option>
          <option value="50_2">ğŸŒ¿ğŸŒ¿ 50åˆ†é˜ (é€£çºŒå…©å ‚)</option>
          <option value="80_1">ğŸ”¥ 80åˆ†é˜ (å–®å ‚)</option>
        </select>
        
        <div class="ticket-box">
          <label id="singleTicketLabel">
            <input type="checkbox" id="singleUseTicket" onchange="updateSinglePlanLogic()" onclick="event.stopPropagation()"> 
            ä½¿ç”¨åŠ æ™‚åˆ¸ (+30åˆ†)
          </label>
        </div>
        <div id="singleTicketHint" style="font-size:12px; color:var(--danger); display:none; margin-top:5px;">
          âš ï¸ æ­¤æ–¹æ¡ˆä¸å¯ä½¿ç”¨åŠ æ™‚åˆ¸
        </div>
      </div>
      
      </div>

    <div id="time-section" style="display:none; margin-top:20px;">
      <h3>é¸æ“‡æ™‚é–“ (<span id="finalDuration">0</span>åˆ†é˜)</h3>
      <input type="date" id="datePicker" onchange="fetchSlots()">
      <div id="slotsContainer" class="time-grid"></div>
    </div>
    
    <button id="confirmBtn" class="btn" style="display:none;" onclick="submitBooking()">ç¢ºèªé ç´„</button>
    <button onclick="resetSystem()" style="width:100%; border:none; background:none; color:#999; margin-top:30px;">ç™»å‡º</button>
  </div>
</div>

<script>
  // ==========================================
  // ã€è«‹ç¢ºèªã€‘æ‚¨çš„ GAS ç¶²å€èˆ‡ LIFF ID
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbxrf6QnXqbca7tYBvHtrAJgskCRkV6qtRtWHak6fr0LXz0rqjyzwZLeu4Qf43SzKwH6/exec'; 
  const MY_LIFF_ID = '2008555385-honVqqwb'; 
  // ==========================================

  let currentUser = {};
  let lineUserId = '';
  let selectedPlan = '';
  let finalDuration = 0;
  let useTicket = false;
  let selectedTime = null;
  // v7.3.3: ç”¨ä¾†è¨˜éŒ„æœ€çµ‚é¡¯ç¤ºçµ¦ç®¡ç†å“¡çš„æ–¹æ¡ˆåç¨±
  let finalPlanDetailName = ""; 

  // åˆå§‹åŒ–
  window.onload = function() {
    liff.init({ liffId: MY_LIFF_ID }).then(() => {
      if (liff.isLoggedIn()) {
        liff.getProfile().then(p => {
          lineUserId = p.userId;
          document.getElementById('status-msg').innerText = `Hello ${p.displayName}`;
        });
      } else {
        liff.login();
      }
    }).catch(e => {
      document.getElementById('status-msg').innerText = "LIFF åˆå§‹åŒ–å¤±æ•— (è«‹æª¢æŸ¥ ID)";
    });
    
    document.getElementById('datePicker').min = new Date().toISOString().split('T')[0];
  };

  // --- é€šç”¨ API è«‹æ±‚å‡½å¼ ---
  function sendRequest(action, data) {
    document.getElementById('loading-overlay').style.display = 'flex';
    data.action = action;
    return fetch(GAS_URL, {
      method: 'POST',
      body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(response => {
      document.getElementById('loading-overlay').style.display = 'none';
      return response;
    })
    .catch(err => {
      document.getElementById('loading-overlay').style.display = 'none';
      alert('ç³»çµ±é€£ç·šå¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦');
      console.error(err);
      throw err;
    });
  }

  // --- ç™»å…¥é‚è¼¯ ---
  function handleLogin() {
    const phone = document.getElementById('loginPhone').value;
    if(!phone) return alert("è«‹è¼¸å…¥é›»è©±");

    sendRequest('loginUser', { phone: phone }).then(res => {
      if(res.success) {
        currentUser = res.user;
        renderMain(); 
        loadBookingHistory(); 
      } else {
        alert(res.message || "æ‰¾ä¸åˆ°æ­¤è™Ÿç¢¼");
        if(!res.success && res.user) { 
           currentUser = res.user; 
           renderMain(); 
           loadBookingHistory();
        }
      }
    });
  }

  // --- ä¸»ç•«é¢æ¸²æŸ“ ---
  function renderMain() {
    document.getElementById('userName').innerText = currentUser.name;
    document.getElementById('ui-course-balance').innerText = currentUser.courseBalance || currentUser.courses || 0;
    document.getElementById('ui-ticket-balance').innerText = currentUser.ticketBalance || currentUser.tickets || 0;

    // é¡¯ç¤ºæ–¹æ¡ˆæ–‡å­—
    let plan = parseInt(currentUser.plan);
    let planText = plan === 80 ? "ğŸ”¥ é«˜éšæ–¹æ¡ˆ (80åˆ†)" : (plan === 50 ? "ğŸŒ± åŸºç¤æ–¹æ¡ˆ (50åˆ†)" : "æœªè¨­å®šæ–¹æ¡ˆ");
    document.getElementById("ui-plan-text").innerText = planText;

    // æ›´æ–°èª²ç¨‹æŒ‰éˆ•æ–‡å­—
    document.getElementById("ui-course-btn-text").innerHTML = `ğŸ’ ä½¿ç”¨èª²ç¨‹ (${plan||50}åˆ†æ–¹æ¡ˆ)`;

    const hasCourse = (currentUser.courseBalance > 0 || currentUser.courses > 0);
    const hasTicket = (currentUser.ticketBalance > 0 || currentUser.tickets > 0);
    
    // æª¢æŸ¥èª²ç¨‹
    const cDiv = document.getElementById('opt-course');
    if(!hasCourse) { 
      cDiv.style.opacity = '0.5'; 
      cDiv.style.pointerEvents = 'none'; 
      cDiv.innerHTML += '<br><span style="color:red;font-size:12px;">(é»æ•¸ä¸è¶³)</span>';
    } else { 
      cDiv.style.opacity = '1'; 
      cDiv.style.pointerEvents = 'auto'; 
    }
    
    // æª¢æŸ¥åŠ æ™‚åˆ¸ (é‡å°èª²ç¨‹å€å¡Šèˆ‡å–®æ¬¡å€å¡Šçš„åˆ¸é€²è¡Œåˆå§‹åŒ–)
    const tCheckCourse = document.getElementById('useTicketCheck');
    const tCheckSingle = document.getElementById('singleUseTicket');

    if(!hasTicket) { 
      tCheckCourse.disabled = true; tCheckCourse.checked = false; 
      tCheckSingle.disabled = true; tCheckSingle.checked = false; 
    } else { 
      // é è¨­å…ˆé–‹å•Ÿï¼Œå…·é«”é‚è¼¯ç”± selectOption æ±ºå®š
      tCheckCourse.disabled = false;
      tCheckSingle.disabled = false;
    }

    document.getElementById('view-login').classList.remove('active');
    document.getElementById('view-main').classList.add('active');
  }

  // --- 1. é¸æ“‡å¤§é¡åˆ¥ (èª²ç¨‹ vs å–®æ¬¡) ---
  function selectOption(type) {
    selectedPlan = type;
    // UI åˆ‡æ›
    document.querySelectorAll('.option-card').forEach(e => e.classList.remove('selected'));
    
    if(type === 'COURSE') {
       document.getElementById('opt-course').classList.add('selected');
       // 5. è§¸ç™¼èª²ç¨‹çš„æ–°é‚è¼¯
       updateCoursePlanLogic(); 
    } else {
       document.getElementById('opt-single').classList.add('selected');
       // è§¸ç™¼å–®æ¬¡çš„é‚è¼¯
       updateSinglePlanLogic();
    }
  }

  // --- 2. [v7.3.3 Update] èª²ç¨‹å°ˆç”¨çš„é‚è¼¯ (æ”¯æ´é¸å–®) ---
  function updateCoursePlanLogic() {
    if(selectedPlan !== 'COURSE') return;

    const select = document.getElementById('coursePlanSelect');
    const ticketCheck = document.getElementById('useTicketCheck');
    const ticketHint = document.getElementById('courseTicketHint');
    
    let baseDuration = parseInt(currentUser.plan) || 50; 
    let val = select.value; // '1' or '2'
    let isTicket = ticketCheck.checked;
    
    let serviceTime = 0, bufferTime = 0, ticketTime = 0;
    let planText = "";
    
    // æª¢æŸ¥æ˜¯å¦æœ‰åŠ æ™‚åˆ¸é¤˜é¡
    const hasTicket = (currentUser.ticketBalance > 0 || currentUser.tickets > 0);

    if (val === '1') {
      // 1å ‚èª²
      planText = `èª²ç¨‹æ‰£æŠµ (1å ‚ ${baseDuration}åˆ†)`;
      
      // æœ‰åˆ¸æ‰èƒ½å‹¾
      if(hasTicket) {
        ticketCheck.disabled = false;
        ticketCheck.parentElement.style.opacity = "1";
      }
      ticketHint.style.display = "none";

      if(isTicket) {
         serviceTime = baseDuration; ticketTime = 30; bufferTime = 10;
      } else {
         serviceTime = baseDuration; bufferTime = 10;
      }

    } else if (val === '2') {
      // 2å ‚èª²
      planText = `èª²ç¨‹æ‰£æŠµ (é€£çºŒ2å ‚ ${baseDuration*2}åˆ†)`;
      
      // 5. è‹¥é¸äº†å…©å ‚ï¼Œå‰‡åŠ æ™‚å·ä¸èƒ½å‹¾é¸
      ticketCheck.checked = false;
      ticketCheck.disabled = true;
      ticketCheck.parentElement.style.opacity = "0.5";
      ticketHint.style.display = "block";
      isTicket = false;

      // ç·©è¡æ™‚é–“è¦å‰‡ï¼šé€£çºŒå…©å ‚ = 20åˆ†ç·©è¡
      serviceTime = baseDuration * 2; 
      bufferTime = 20;
    }

    // è¨ˆç®—å‚³çµ¦å¾Œç«¯çš„ç¸½ä½”ç”¨æ™‚é–“
    let totalOccupied = serviceTime + ticketTime + bufferTime;
    
    useTicket = isTicket;
    finalPlanDetailName = planText + (isTicket ? " + åŠ æ™‚åˆ¸" : "");
    
    setDuration(totalOccupied);
  }

  // --- 3. [v7.3.3 Update] å–®æ¬¡ä»˜è²»çš„é‚è¼¯ (éš±è—é¡¯ç¤ºæ–‡å­—) ---
  function updateSinglePlanLogic() {
    if(selectedPlan !== 'SINGLE') return;

    const select = document.getElementById('singlePlanSelect');
    const ticketCheck = document.getElementById('singleUseTicket');
    const ticketLabel = document.getElementById('singleTicketLabel');
    const ticketHint = document.getElementById('singleTicketHint');

    const val = select.value; 
    let isTicket = ticketCheck.checked;
    let serviceTime = 0, bufferTime = 0, ticketTime = 0;
    let planText = "";
    
    // æª¢æŸ¥åˆ¸é¤˜é¡ (å–®æ¬¡ä»˜è²»è‹¥éœ€ä½¿ç”¨åˆ¸) -> é€™è£¡é‚è¼¯é€šå¸¸æ˜¯å–®æ¬¡ä»˜è²»è‹¥è¦åŠ æ™‚æ˜¯ç›´æ¥åŠ éŒ¢ï¼Œé‚„æ˜¯æ‰£åˆ¸ï¼Ÿ
    // æ ¹æ“š v7.3.1 é‚è¼¯ï¼Œå–®æ¬¡ä»˜è²»ä¹Ÿå¯ä»¥å‹¾é¸ "ä½¿ç”¨åŠ æ™‚åˆ¸ (+30åˆ†)"ï¼Œé€™è£¡å‡è¨­é‚è¼¯ä¸€è‡´
    // ç‚ºäº†å®‰å…¨ï¼Œæˆ‘å€‘æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦æœ‰åˆ¸ï¼Œè‹¥ç„¡å‰‡ disable checkbox (æˆ–ä¾æ‚¨çš„å•†æ¥­é‚è¼¯ï¼šä»˜è²»åŠ æ™‚ä¸æ‰£åˆ¸ï¼Ÿ)
    // é€™è£¡ç¶­æŒåŸæ¨£ï¼šå‡è¨­æ˜¯è¦æ‰£åˆ¸
    const hasTicket = (currentUser.ticketBalance > 0 || currentUser.tickets > 0);

    if (val === '50_1') {
      planText = "å–®æ¬¡é ç´„ (50åˆ†)";
      if(hasTicket) { ticketCheck.disabled = false; ticketLabel.style.opacity = "1"; }
      ticketHint.style.display = "none";
      if (isTicket) { serviceTime = 50; ticketTime = 30; bufferTime = 10; } 
      else { serviceTime = 50; bufferTime = 10; }

    } else if (val === '50_2') {
      planText = "å–®æ¬¡é ç´„ (é€£çºŒå…©å ‚ 100åˆ†)";
      ticketCheck.checked = false; ticketCheck.disabled = true;
      ticketLabel.style.opacity = "0.5"; ticketHint.style.display = "block";
      isTicket = false;
      serviceTime = 100; bufferTime = 20;

    } else if (val === '80_1') {
      planText = "å–®æ¬¡é ç´„ (80åˆ†)";
      if(hasTicket) { ticketCheck.disabled = false; ticketLabel.style.opacity = "1"; }
      ticketHint.style.display = "none";
      if (isTicket) { serviceTime = 80; ticketTime = 30; bufferTime = 10; } 
      else { serviceTime = 80; bufferTime = 10; }
    }

    let totalOccupied = serviceTime + ticketTime + bufferTime;
    
    useTicket = isTicket;
    finalPlanDetailName = planText + (isTicket ? " + åŠ æ™‚åˆ¸" : "");
    
    setDuration(totalOccupied);
  }

  // --- 4. é€å‡ºé ç´„ ---
  function submitBooking() {
    if(!selectedTime) return alert("è«‹é¸æ“‡æ™‚é–“");
    
    // ä½¿ç”¨è¨ˆç®—å¥½çš„åç¨±
    let planDesc = finalPlanDetailName;
    
    // 1. éš±è—è¤‡é›œçš„ç·©è¡é‹ç®—ï¼Œåªçµ¦ç”¨æˆ¶çœ‹é‡é»
    let msg = `ç¢ºèªé ç´„è³‡è¨Šï¼š\n\næ—¥æœŸï¼š${document.getElementById('datePicker').value}\næ™‚é–“ï¼š${selectedTime}\né …ç›®ï¼š${planDesc}`;
    
    if(!confirm(msg)) return;
    
    sendRequest('createBooking', {
      date: document.getElementById('datePicker').value,
      time: selectedTime,
      duration: finalDuration, // å‚³é€å«ç·©è¡çš„ç¸½æ™‚é–“
      name: currentUser.name,
      phone: currentUser.phone,
      lineUserId: lineUserId,
      plan: selectedPlan, 
      customPlanName: planDesc, // å‚³é€æœ€çµ‚æ–¹æ¡ˆåç¨±
      useTicket: useTicket
    }).then(res => {
      if(res.success) {
        alert("âœ… é ç´„æˆåŠŸï¼LINE é€šçŸ¥å·²ç™¼é€");
        resetSystem();
      } else {
        alert("âŒ é ç´„å¤±æ•—ï¼š" + (res.error || "æœªçŸ¥éŒ¯èª¤"));
      }
    });
  }

  function setDuration(min) {
    finalDuration = min;
    document.getElementById('finalDuration').innerText = min;
    document.getElementById('time-section').style.display = 'block';
    
    if(document.getElementById('datePicker').value) {
      fetchSlots();
    }
  }

  function fetchSlots() {
    const date = document.getElementById('datePicker').value;
    if(!date) return;
    
    const div = document.getElementById('slotsContainer');
    div.innerHTML = '<div style="grid-column:1/-1; text-align:center;">æŸ¥è©¢ä¸­...</div>';

    sendRequest('getAvailableSlots', { date: date, duration: finalDuration }).then(res => {
      div.innerHTML = '';
      if(res.status === 'FULL') {
        div.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:red;">æœ¬æ—¥å·²é¡æ»¿</div>';
      } else if(!res.slots || res.slots.length === 0) {
        div.innerHTML = '<div style="grid-column:1/-1; text-align:center;">ç„¡ç¬¦åˆæ™‚æ®µ</div>';
      } else {
        res.slots.forEach(t => {
          let el = document.createElement('div');
          el.className = 'time-slot';
          el.innerText = t;
          el.onclick = () => {
             document.querySelectorAll('.time-slot').forEach(x=>x.classList.remove('selected'));
             el.classList.add('selected');
             selectedTime = t;
             document.getElementById('confirmBtn').style.display = 'block';
          }
          div.appendChild(el);
        });
      }
    });
  }

  function loadBookingHistory() {
    const listDiv = document.getElementById('bookingList');
    const section = document.getElementById('history-section');
    
    listDiv.innerHTML = '<div style="text-align:center; color:#999;">è¼‰å…¥ä¸­...</div>';
    section.style.display = 'block';

    sendRequest('getBookingHistory', { phone: currentUser.phone }).then(res => {
      listDiv.innerHTML = ''; 
      if (!res.bookings || res.bookings.length === 0) {
        listDiv.innerHTML = '<div style="text-align:center; color:#999; padding:10px;">ç›®å‰æ²’æœ‰æœªä¾†çš„é ç´„</div>';
        return;
      }
      res.bookings.forEach(b => {
        const item = document.createElement('div');
        item.className = 'booking-item';
        let displayTime = b.start.split('T')[1] ? b.start.split('T')[1].substring(0,5) : b.start;
        let displayDate = b.start.split('T')[0];

        item.innerHTML = `
          <div class="booking-info">
            <span class="booking-time">${displayDate} ${displayTime}</span>
            <span>${b.title}</span>
          </div>
          <button class="cancel-btn" onclick="triggerCancel('${b.id}', '${displayDate} ${displayTime}')">å–æ¶ˆ</button>
        `;
        listDiv.appendChild(item);
      });
    });
  }

  function triggerCancel(eventId, timeStr) {
    if(!confirm(`ç¢ºå®šè¦å–æ¶ˆ ${timeStr} çš„é ç´„å—ï¼Ÿ\n(æ­¤æ“ä½œç„¡æ³•å¾©åŸ)`)) return;
    sendRequest('cancelBooking', {
      eventId: eventId,
      phone: currentUser.phone,
      name: currentUser.name,
      lineUserId: lineUserId
    }).then(res => {
      if(res.success) { alert('âœ… å–æ¶ˆæˆåŠŸï¼'); loadBookingHistory(); }
      else { alert('âŒ å–æ¶ˆå¤±æ•—ï¼š' + res.error); }
    });
  }

  function resetSystem() {
    location.reload();
  }
</script>

</body>
</html>
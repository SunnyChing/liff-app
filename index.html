<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VIP é ç´„</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* CSS è¨­å®š (ç¶­æŒä¸è®Š) */
    :root { --primary: #246A53; --bg: #f5f5f5; --white: #fff; --accent: #F0C239; }
    body { margin: 0; padding: 0; font-family: sans-serif; background: var(--bg); color: #333; }
    .container { max-width: 600px; margin: 0 auto; min-height: 100vh; background: var(--white); }
    
    .view { display: none; padding: 20px; animation: fadeIn 0.3s; }
    .view.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* å€å¡Š A: æœƒå“¡è³‡è¨Šå¡ */
    .member-card {
      background: linear-gradient(135deg, #246A53, #1a4f3d);
      color: white; border-radius: 15px; padding: 20px;
      margin-bottom: 25px; box-shadow: 0 4px 10px rgba(36, 106, 83, 0.3);
    }
    .member-hello { font-size: 18px; margin-bottom: 15px; font-weight: bold; }
    .member-stats { display: flex; justify-content: space-around; text-align: center; }
    .stat-box { background: rgba(255,255,255,0.1); padding: 10px 15px; border-radius: 10px; min-width: 100px; }
    .stat-num { font-size: 24px; font-weight: bold; color: var(--accent); }
    .stat-label { font-size: 12px; opacity: 0.9; margin-top: 5px; }

    /* å€å¡Š B: é¸é …å¡ç‰‡ */
    .section-title { font-weight: bold; margin-bottom: 10px; color: var(--primary); border-left: 4px solid var(--accent); padding-left: 10px; }
    .option-card { border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 15px; cursor: pointer; transition: 0.2s; background: #fff; }
    .option-card.selected { border: 2px solid var(--primary); background: #f0fdf4; }
    .option-card.disabled { opacity: 0.6; cursor: not-allowed; background: #f9f9f9; border-color: #ddd; }
    
    .option-header { font-weight: bold; font-size: 16px; margin-bottom: 5px; display: flex; justify-content: space-between; }
    .option-desc { font-size: 13px; color: #666; }

    /* åŠ æ™‚åˆ¸å‹¾é¸å€ */
    .ticket-option { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc; font-size: 14px; }
    .ticket-label { display: flex; align-items: center; cursor: pointer; }
    
    /* å–®æ¬¡é ç´„æŒ‰éˆ•ç¾¤ */
    .duration-group { display: flex; gap: 10px; margin-top: 10px; }
    .d-btn { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; background: white; text-align: center; cursor: pointer; }
    .d-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

    /* é€šç”¨å…ƒä»¶ */
    input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; background: var(--primary); color: white; margin-top: 10px; }
    .btn:disabled { background: #ccc; }
    
    /* æ™‚é–“ç¶²æ ¼ */
    .time-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 15px; }
    .time-slot { padding: 10px; border: 1px solid #ccc; border-radius: 5px; text-align: center; cursor: pointer; }
    .time-slot.selected { background: var(--accent); border-color: var(--accent); color: var(--primary); font-weight: bold; }

    #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:none; justify-content:center; align-items:center; z-index:99; }
    #system-status { text-align: center; font-size: 12px; color: #999; margin-top: 10px; }
  </style>
</head>
<body>

<div class="container">
  <div id="loading-overlay">è™•ç†ä¸­...</div>

  <div id="view-login" class="view active">
    <div style="text-align:center; margin-top:60px; padding: 20px;">
      <h2 style="color:var(--primary);">VIP é ç´„</h2>
      <p style="color:#666;">è«‹è¼¸å…¥é›»è©±æŸ¥è©¢æœƒå“¡è³‡æ–™</p>
      
      <input type="tel" id="loginPhone" placeholder="æ‚¨çš„æ‰‹æ©Ÿè™Ÿç¢¼">
      
      <button class="btn" onclick="handleLogin()">æŸ¥è©¢ / ç™»å…¥</button>
      
      <div id="system-status">ç³»çµ±è¼‰å…¥ä¸­...</div>
    </div>
  </div>

  <div id="view-main" class="view">
    
    <div class="member-card">
      <div class="member-hello">ä½ å¥½ï¼Œ<span id="userName">--</span></div>
      <div class="member-stats">
        <div class="stat-box">
          <div class="stat-num" id="userCourses">0</div>
          <div class="stat-label">å‰©é¤˜èª²ç¨‹</div>
        </div>
        <div class="stat-box">
          <div class="stat-num" id="userTickets">0</div>
          <div class="stat-label">åŠ æ™‚åˆ¸</div>
        </div>
      </div>
    </div>

    <div class="section-title">æˆ‘è¦é ç´„</div>

    <div id="opt-course" class="option-card" onclick="selectOption('COURSE')">
      <div class="option-header">
        <span>ğŸ’ ä½¿ç”¨èª²ç¨‹</span>
        <span id="courseTag" style="font-size:12px; background:#eee; padding:2px 6px; border-radius:4px;">50åˆ†é˜</span>
      </div>
      <div class="option-desc">æ‰£é™¤ 1 å ‚èª² (å‰©é¤˜ <span id="courseDisplay">0</span> å ‚)</div>
      
      <div class="ticket-option" id="ticketSection">
        <label class="ticket-label">
          <input type="checkbox" id="useTicketCheck" disabled onclick="event.stopPropagation(); toggleTicket();">
          <span style="margin-left:8px;">æ­é…åŠ æ™‚åˆ¸ (+30åˆ†é˜)</span>
        </label>
        <div style="font-size:12px; color:#888; margin-left:24px;">æŒæœ‰ <span id="ticketDisplay">0</span> å¼µ</div>
      </div>
    </div>

    <div id="opt-single" class="option-card" onclick="selectOption('SINGLE')">
      <div class="option-header">ğŸ’° å–®æ¬¡é ç´„</div>
      <div class="option-desc">éæœƒå“¡æˆ–å–®æ¬¡ä»˜è²»</div>
      
      <div class="duration-group">
        <div class="d-btn" onclick="event.stopPropagation(); setSingleDuration(50, this)">50 åˆ†é˜</div>
        <div class="d-btn" onclick="event.stopPropagation(); setSingleDuration(80, this)">80 åˆ†é˜</div>
      </div>
    </div>

    <div id="time-section" style="display:none; margin-top:25px;">
      <hr style="border:0; border-top:1px dashed #ddd; margin-bottom:20px;">
      <div class="section-title">é¸æ“‡æ™‚é–“ (<span id="finalDuration">0</span>åˆ†é˜)</div>
      <input type="date" id="datePicker" onchange="fetchSlots()">
      <div id="slotsContainer" class="time-grid"></div>
      <button id="confirmBtn" class="btn" style="display:none;" onclick="submitBooking()">ç¢ºèªé ç´„</button>
    </div>

    <button onclick="resetSystem()" style="width:100%; padding:15px; border:none; background:none; color:#999; margin-top:30px;">â†º é‡æ–°æŸ¥è©¢ / ç™»å‡º</button>
  </div>
</div>

<script>
  // ã€æ³¨æ„ã€‘è«‹å¡«å…¥æ‚¨çš„ LIFF ID
  const MY_LIFF_ID = '2008555385-0D1eLEbY'; 

  let currentUser = { name:'', phone:'', courses:0, tickets:0 };
  let selectedPlan = ''; 
  let finalDuration = 0;
  let useTicket = false;
  let selectedTime = null;
  let lineUserId = 'GUEST_WEB'; 

// --- ä¿®æ­£å¾Œçš„ window.onload (é˜²å¡æ­»ç‰ˆ) ---
  window.onload = function() {
    // 1. è¨­å®šæ—¥æœŸè¼¸å…¥æ¡†
    try {
        const dp = document.getElementById('datePicker');
        if(dp) dp.min = new Date().toISOString().split("T")[0];
    } catch(e){}

    // 2. ã€é—œéµä¿®æ­£ã€‘å•Ÿå‹•é˜²å¡æ­»è¨ˆæ™‚å™¨ 
    // å¦‚æœ 3 ç§’å¾Œé‚„åœ¨è¼‰å…¥ï¼Œå¼·åˆ¶é¡¯ç¤ºä»‹é¢ï¼Œè®“å®¢äººçŸ¥é“å¯ä»¥ç”¨
    const statusDiv = document.getElementById('system-status');
    setTimeout(() => {
        if(statusDiv && statusDiv.innerText.includes('è¼‰å…¥ä¸­')) {
            console.log('LIFF è¼‰å…¥è¶…æ™‚ï¼Œå¼·åˆ¶å•Ÿç”¨ç¶²é æ¨¡å¼');
            statusDiv.innerText = 'ç³»çµ±æº–å‚™å°±ç·’ (è«‹ç›´æ¥è¼¸å…¥é›»è©±)'; // æ”¹æˆè®“å®¢äººå®‰å¿ƒçš„å­—
            statusDiv.style.color = '#246A53'; // æ”¹æˆç¶ è‰²
        }
    }, 2500); // 2.5ç§’å¾ŒåŸ·è¡Œ

    // 3. åŸ·è¡ŒåŸæœ¬çš„ LIFF åˆå§‹åŒ–
    initializeLiff();
  };

  function initializeLiff() {
    const statusDiv = document.getElementById('system-status');
    liff.init({ liffId: MY_LIFF_ID }).then(() => {
        if (liff.isInClient()) {
          if (!liff.isLoggedIn()) liff.login();
          else liff.getProfile().then(p => {
              lineUserId = p.userId;
              if(statusDiv) statusDiv.innerText = `Hi, ${p.displayName}`;
          }).catch(e => console.error(e));
        } else {
          if(statusDiv) statusDiv.innerText = 'ç¶²é ç‰ˆè¨ªå®¢æ¨¡å¼ (ç„¡éœ€ LINE ç™»å…¥)';
        }
    }).catch(e => {
        console.error(e);
        if(statusDiv) statusDiv.innerText = 'ç³»çµ±æ¨¡å¼ (LIFF æœªè¼‰å…¥)';
    });
  }

  // --- ã€é—œéµä¿®æ­£ã€‘ç³»çµ±é‡ç½®å‡½æ•¸ (å›åˆ°é¦–é ) ---
  function resetSystem() {
    // 1. æ¸…ç©ºè®Šæ•¸
    currentUser = { name:'', phone:'', courses:0, tickets:0 };
    selectedTime = null;
    selectedPlan = '';
    finalDuration = 0;
    
    // 2. æ¸…ç©ºæ¬„ä½
    document.getElementById('loginPhone').value = ''; 
    document.getElementById('datePicker').value = '';
    
    // 3. é‚„åŸä»‹é¢ç‹€æ…‹
    document.getElementById('slotsContainer').innerHTML = '';
    document.getElementById('time-section').style.display = 'none';
    document.getElementById('confirmBtn').style.display = 'none';
    
    document.querySelectorAll('.option-card').forEach(e => e.classList.remove('selected'));
    document.querySelectorAll('.d-btn').forEach(e => e.classList.remove('active'));
    document.getElementById('useTicketCheck').checked = false;
    document.getElementById('useTicketCheck').disabled = true;

    // 4. åˆ‡æ›å›ç™»å…¥é 
    document.getElementById('view-main').classList.remove('active');
    document.getElementById('view-login').classList.add('active');
    
    // 5. æ²å‹•åˆ°é ‚éƒ¨
    window.scrollTo(0,0);
  }

  // --- ç™»å…¥é‚è¼¯ ---
  function handleLogin() {
    const phone = document.getElementById('loginPhone').value;
    if(!phone) return alert('è«‹è¼¸å…¥é›»è©±');
    
    document.getElementById('loading-overlay').style.display = 'flex';
    google.script.run.withSuccessHandler(res => {
      document.getElementById('loading-overlay').style.display = 'none';
      if(res.success || res.user) { 
        currentUser = res.user;
        renderMainView();
      } else {
        alert('ç³»çµ±éŒ¯èª¤: ' + (res.message || 'æœªçŸ¥éŒ¯èª¤'));
      }
    }).loginUser(phone);
  }

  // --- æ¸²æŸ“ä¸»ç•«é¢ ---
  function renderMainView() {
    document.getElementById('userName').innerText = currentUser.name;
    document.getElementById('userCourses').innerText = currentUser.courses;
    document.getElementById('userTickets').innerText = currentUser.tickets;
    document.getElementById('courseDisplay').innerText = currentUser.courses;
    document.getElementById('ticketDisplay').innerText = currentUser.tickets;

    const courseCard = document.getElementById('opt-course');
    const ticketCheck = document.getElementById('useTicketCheck');

    if (currentUser.courses > 0) {
      courseCard.classList.remove('disabled');
      courseCard.style.pointerEvents = 'auto';
    } else {
      courseCard.classList.add('disabled');
      courseCard.style.pointerEvents = 'none';
    }

    if (currentUser.tickets > 0) ticketCheck.disabled = false;
    else { ticketCheck.disabled = true; ticketCheck.checked = false; }

    document.getElementById('view-login').classList.remove('active');
    document.getElementById('view-main').classList.add('active');
  }

  // --- é¸é …é‚è¼¯ ---
  function selectOption(type) {
    document.querySelectorAll('.option-card').forEach(e => e.classList.remove('selected'));
    document.querySelectorAll('.d-btn').forEach(e => e.classList.remove('active'));
    document.getElementById('slotsContainer').innerHTML = '';
    document.getElementById('confirmBtn').style.display = 'none';

    if (type === 'COURSE') {
      if (currentUser.courses <= 0) return alert('å‰©é¤˜èª²ç¨‹ä¸è¶³');
      document.getElementById('opt-course').classList.add('selected');
      selectedPlan = 'COURSE';
      toggleTicket(); 
    } 
    else if (type === 'SINGLE') {
      document.getElementById('opt-single').classList.add('selected');
      selectedPlan = 'SINGLE';
      useTicket = false;
      document.getElementById('time-section').style.display = 'none';
    }
  }

  function toggleTicket() {
    if (selectedPlan !== 'COURSE') return;
    const isChecked = document.getElementById('useTicketCheck').checked;
    useTicket = isChecked;
    finalDuration = isChecked ? 80 : 50;
    
    document.getElementById('courseTag').innerText = finalDuration + 'åˆ†é˜';
    document.getElementById('courseTag').style.background = isChecked ? '#F0C239' : '#eee';
    document.getElementById('finalDuration').innerText = finalDuration;
    document.getElementById('time-section').style.display = 'block';
    if(document.getElementById('datePicker').value) fetchSlots();
  }

  function setSingleDuration(mins, btn) {
    if (selectedPlan !== 'SINGLE') selectOption('SINGLE');
    document.querySelectorAll('.d-btn').forEach(e => e.classList.remove('active'));
    btn.classList.add('active');
    finalDuration = mins;
    useTicket = false;
    document.getElementById('finalDuration').innerText = finalDuration;
    document.getElementById('time-section').style.display = 'block';
    if(document.getElementById('datePicker').value) fetchSlots();
  }

  // --- æ’ˆå–æ™‚æ®µ ---
  function fetchSlots() {
    const date = document.getElementById('datePicker').value;
    if (!date || finalDuration === 0) return;
    document.getElementById('slotsContainer').innerHTML = '<div style="grid-column:1/-1;text-align:center;">è¼‰å…¥ä¸­...</div>';
    
    google.script.run.withSuccessHandler(res => {
      const container = document.getElementById('slotsContainer');
      container.innerHTML = '';
      if(res.status === 'FULL') { container.innerHTML = 'ä»Šæ—¥å·²æ»¿'; return; }
      if(res.slots.length === 0) { container.innerHTML = 'ç„¡ç©ºæª”'; return; }
      
      res.slots.forEach(time => {
        const div = document.createElement('div');
        div.className = 'time-slot';
        div.innerText = time;
        div.onclick = () => {
          document.querySelectorAll('.time-slot').forEach(e => e.classList.remove('selected'));
          div.classList.add('selected');
          selectedTime = time;
          document.getElementById('confirmBtn').style.display = 'block';
        };
        container.appendChild(div);
      });
    }).getAvailableSlots(date, finalDuration);
  }
// --- ä¿®æ­£å¾Œçš„é€å‡ºé ç´„å‡½å¼ ---
  function submitBooking() {
    if(!selectedTime) return alert('è«‹é¸æ“‡æ™‚é–“');
    
    // å†æ¬¡ç¢ºèªè³‡æ–™
    const uName = currentUser.name || document.getElementById('userName').value || 'è¨ªå®¢';
    const uPhone = currentUser.phone || document.getElementById('loginPhone').value;
    
    // ç¢ºä¿æœ‰é›»è©±
    if(!uPhone) return alert('ç³»çµ±éŒ¯èª¤ï¼šç„¡æ³•è®€å–é›»è©±ï¼Œè«‹é‡æ–°ç™»å…¥');

    const confirmMsg = `ç¢ºå®šé ç´„ï¼Ÿ\n\næ—¥æœŸï¼š${document.getElementById('datePicker').value}\næ™‚é–“ï¼š${selectedTime}\næ–¹æ¡ˆï¼š${selectedPlan === 'COURSE' ? 'ä½¿ç”¨èª²ç¨‹' : 'å–®æ¬¡'}\næ™‚é•·ï¼š${finalDuration}åˆ†é˜`;
    if(!confirm(confirmMsg)) return;
    
    document.getElementById('loading-overlay').style.display = 'flex';
    
    // å‘¼å«å¾Œç«¯
    google.script.run
      .withSuccessHandler(res => {
        document.getElementById('loading-overlay').style.display = 'none';
        if(res.success) {
          alert('âœ… é ç´„æˆåŠŸï¼\nç³»çµ±å°‡è‡ªå‹•è¿”å›é¦–é ã€‚');
          resetSystem(); 
        } else {
          alert('âŒ å¤±æ•—ï¼š' + res.error);
        }
      })
      .withFailureHandler(err => {
         // é€™è£¡æ˜¯æŠ“å‡ºã€Œå¡åœ¨è™•ç†ä¸­ã€çœŸæ­£åŸå› çš„é—œéµ
         document.getElementById('loading-overlay').style.display = 'none';
         alert('ç³»çµ±ç™¼ç”Ÿåš´é‡éŒ¯èª¤ (è«‹æˆªåœ–çµ¦ç®¡ç†å“¡)ï¼š\n' + err.message);
      })
      .createBooking(
        document.getElementById('datePicker').value, // 1. æ—¥æœŸ
        selectedTime,                                // 2. æ™‚é–“
        finalDuration,                               // 3. é•·åº¦
        uName,                                       // 4. å§“å
        uPhone,                                      // 5. é›»è©±
        lineUserId,                                  // 6. LineID (çµ¦å¾Œç«¯ç™¼é€šçŸ¥ç”¨)
        selectedPlan,                                // 7. æ–¹æ¡ˆé¡å‹
        useTicket                                    // 8. æ˜¯å¦ç”¨åˆ¸
      );
  }
</script>
</body>
</html>
